!function(t){"use strict";let e=function(o,i){let n=this;this.$element=t(o);this.options=t.extend({},e.DEFAULTS,i);this.id=gui.getUID("ac");this.lastSearch=null;this.dropdown=null;this.$element.on("keydown",(function(t){n.keydown(t)})).on("keyup",(function(t){n.keyup(t)}));if(this.$element.prev().is("input[type=hidden]")){t(".control-label label",this.$element.parents("form-group")).on("click",(function(){n.$element.trigger("focus")}))}};e.prototype.keydown=function(o){switch(o.keyCode){case e.KEYS.ARROW_DOWN:case e.KEYS.PAGE_DOWN:o.preventDefault();this.move(1);break;case e.KEYS.ARROW_UP:case e.KEYS.PAGE_UP:o.preventDefault();this.move(-1);break;case e.KEYS.TAB:case e.KEYS.ENTER:if(this.dropdown&&t("a.active",this.dropdown).length){o.preventDefault();this.validate(t("a.active",this.dropdown))}else if(this.dropdown){this.removeDropdown()}break}};e.prototype.keyup=function(t){switch(t.keyCode){case e.KEYS.ESCAPE:if(this.dropdown){t.preventDefault();this.removeDropdown()}break;case e.KEYS.TAB:case e.KEYS.ENTER:if(this.dropdown){t.preventDefault()}break;default:if(this.$element.val().length>=this.options.minLength&&this.lastSearch!==this.$element.val()){this.search();this.lastSearch=this.$element.val()}else if(this.$element.val().length<1&&this.dropdown){this.removeDropdown()}break}};e.prototype.removeDropdown=function(){if(this.dropdown){this.dropdown.remove();this.lastSearch=null;this.dropdown=null;t(document).off("mousedown.gui.autocomplete touchend.gui.autocomplete");t(window).off("resize.gui.autocomplete scroll.gui.autocomplete")}};e.prototype.search=function(){let e=this;if(this.options.url!==null){if(this.xhr!==undefined){this.xhr.abort()}this.xhr=t.ajax({url:this.options.url,headers:{"X-CSRF-TOKEN":t('meta[name="csrf-token"]').attr("content")},data:{term:this.$element.val(),limit:this.options.limit},cache:this.options.cache,success:function(t){e.processData(t)}})}};e.prototype.processData=function(t){if(typeof t!=="object"){t=JSON.parse()}if(t.length){this.fill(t)}else{this.removeDropdown()}};e.prototype.fill=function(e){if(!t("#"+this.id).length){t("body").append(t('<div id="'+this.id+'" class="dropdown-menu autocomplete" />'));t(window).on("resize.gui.autocomplete scroll.gui.autocomplete",(function(){o.updatePosition()}));t(document).on("mousedown.gui.autocomplete touchend.gui.autocomplete",(function(e){if(!t(e.target).closest(".dropdown-menu.autocomplete").length){o.removeDropdown()}}))}let o=this;let i=0;this.dropdown=t("#"+this.id).empty();t.each(e,(function(e,n){if(i<=o.options.limit){let e=t('<a class="dropdown-item" />');if(n[o.options.textField]!==undefined){e.html(n[o.options.textField])}else{e.html(JSON.stringify(n))}e.attr("data-value",n[o.options.valueField]??o.escape(e));e.on("click",(function(t){t.preventDefault();o.validate(e)}));o.dropdown.append(e);i++}}));this.updatePosition()};e.prototype.escape=function(t){if(t.find("[data-text]").length){return t.find("[data-text]")[0].innerText}else{return t[0].innerText}};e.prototype.updatePosition=function(){let t=this.$element.attr("data-reference")=="parent"?this.$element.parent():this.$element;let e=t.offset();e.top+=t.outerHeight();this.dropdown.css({top:e.top,left:e.left,minWidth:t.outerWidth()})};e.prototype.move=function(e){if(this.dropdown){if(t("a.active",this.dropdown).length>0){let o=t("a.active",this.dropdown);if(o.is("a:"+(e<0?"first-child":"last-child"))){o.removeClass("active");t("a:"+(e<0?"last-child":"first-child"),this.dropdown).addClass("active")}else{o.removeClass("active");if(e>0){o.next().addClass("active")}else{o.prev().addClass("active")}}}else{t("a:first-child",this.dropdown).addClass("active")}}};e.prototype.validate=function(t){let e=this.escape(t);let o=[t.data("value"),e];this.$element.val(e);this.removeDropdown();this.$element.trigger("gui.validate",o)};e.KEYS={ARROW_UP:38,ARROW_DOWN:40,PAGE_UP:33,PAGE_DOWN:34,ESCAPE:27,ENTER:13,TAB:9};e.DEFAULTS={url:null,cache:false,minLength:1,limit:10,valueField:"value",textField:"text"};t.fn.GUIControlAutocomplete=function(o){t.each(this,(function(){let i=t(this);let n=i.data("gui.autocomplete");let s=typeof o=="object"&&o;if(!n)i.data("gui.autocomplete",new e(this,s))}))}}(jQuery);