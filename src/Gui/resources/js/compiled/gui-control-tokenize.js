!function(e){"use strict";let t={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,UP:38,DOWN:40,CTRL:17,SHIFT:16};let n=function(i,o){let s=this;let r=e.extend({},n.DEFAULTS,o);e.extend(s,{$select:e(i),$input:e('<input type="text" autocomplete="new-password" />'),$document:e(document),$window:e(window),$testInput:null,$activeOption:null,settings:r,eventNS:"."+gui.getUID("tokenize"),isOpen:false,lastValue:"",isShiftDown:false,isDisabled:false,isInputDetach:false,xhr:null,sifter:new Sifter({},{diacritics:true})});s.isDisabled=s.$select.attr("readonly")||s.$select.attr("disabled");s.setupTemplates();s.$container=e(".tokenize-container",s.$select.parent());s.$dropdown=e('<div class="dropdown-menu autocomplete" />');s.$input.on({mousedown:function(e){return s.onMouseDown(e)},keydown:function(e){return s.onKeyDown(e)},keypress:function(e){return s.onKeyPress(e)},input:function(){return s.onInput()},focus:function(){return s.onFocus()},blur:function(){return s.onBlur()}}).appendTo(s.$container);s.autoGrow(s.$input);s.$dropdown.on("mousedown touchstart","[data-selectable]",(function(e){return s.onOptionSelect(e)}));s.$container.on("focusout",(function(){s.resetPending()}));s.$container.on("mousedown touchstart",".token>a",(function(t){if(t.button<1)s.removeItem(e(this).parent().attr("data-value"))}));s.$document.on(["keydown"+s.eventNS,"keyup"+s.eventNS].join(" "),(function(e){if(e.type==="keydown"){s.isShiftDown=e.shiftKey}else{if(e.which===t.SHIFT)s.isShiftDown=false}}));if(s.settings.layoutDirection==="column"){s.$container.addClass("layout-column")}else{s.$container.addClass("layout-row")}if(s.$select.attr("multiple")){e("option:selected",s.$select).each((function(){s.insertAtCaret(s.render("item",{value:e(this).attr("value"),text:e(this).html()}))}))}else{if(s.$select[0].selectedIndex>0){let t=e("option:selected",s.$select).first();s.insertAtCaret(s.render("item",{value:t.attr("value"),text:t.html()}))}}if(r.sortable&&!s.isDisabled){s.$container.addClass("sortable");new Sortable(s.$container[0],{handle:".token>span",draggable:".token",animation:100,forceFallback:true,onSort:function(){s.updateSelect()}})}if(s.$select.attr("data-placeholder")){s.$input.attr("placeholder",s.$select.attr("data-placeholder"));s.$input.trigger("change")}s.setTextboxVisibility(!s.isFull());if(s.isDisabled){s.$container.addClass("disabled");s.setTextboxVisibility(false)}};n.prototype.setupTemplates=function(){let t=this.settings;let n="text";let i={option:function(e,t){return'<div class="dropdown-item">'+t(e[n])+"</div>"},item:function(e,t){return'<div class="token"><span>'+t(e[n])+'</span><div class="vr"></div><a><i class="fa-solid fa-xmark"></i></a></div>'}};t.render=e.extend({},i,t.render)};n.prototype.isFull=function(){if(this.settings.maxItems===null){return false}if(this.$select.attr("multiple")){return e("option:selected",this.$select).length>=this.settings.maxItems}else{return this.$select[0].selectedIndex>0}};n.prototype.setTextboxValue=function(e){this.$input.val(e).trigger("change")};n.prototype.setTextboxVisibility=function(e){let t=this;if(e){if(t.isInputDetach){t.$input.appendTo(t.$container);t.isInputDetach=false}}else{t.$input.detach();t.isInputDetach=true}};n.prototype.dropdownOpen=function(){let t=this;t.$dropdown.appendTo("body");t.isOpen=true;t.$window.on(["scroll"+t.eventNS,"resize"+t.eventNS].join(" "),(function(){if(t.isOpen){t.updatePosition()}}));t.$document.on(["mousedown"+t.eventNS,"touchend"+t.eventNS].join(" "),(function(n){if(!e(n.target).closest(t.$container).length&&!e(n.target).closest(t.$dropdown).length&&t.isOpen){t.dropdownRemove()}}));t.updatePosition()};n.prototype.dropdownRemove=function(){let e=this;e.$document.off(["mousedown"+e.eventNS,"touchend"+e.eventNS].join(" "));e.$window.off(["scroll"+e.eventNS,"resize"+e.eventNS].join(" "));e.$dropdown.detach();e.isOpen=false;e.$activeOption=null};n.prototype.updatePosition=function(){let e=this;let t=e.$container.offset();t.top+=e.$container.outerHeight();e.$dropdown.css({top:t.top,left:t.left}).outerWidth(e.$container.outerWidth())};n.prototype.search=function(){let t,n,i=[],o=[],s=this;let r=s.settings;let a=s.$input.val().trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"");if(s.settings.provider!=="select"){s.searchRemote(a)}else{e("option",s.$select).not(":selected, :disabled").each((function(){i.push({value:e(this).attr("value").trim(),text:e(this).html().trim()})}));s.sifter.items=i;n=s.sifter.search(a,{fields:"text",conjunction:r.searchConjunction,respect_word_boundaries:r.searchRespectWordBoundaries});if(n.items.length>0){for(t=0;t<n.items.length;t++){o.push(i[n.items[t]["id"]])}}s.parseResults(o)}};n.prototype.searchRemote=function(t){let n=this,i=[];if(n.xhr!==undefined&&n.xhr!==null){n.xhr.abort()}n.xhr=e.ajax(n.settings.provider,{data:{[n.settings.providerQueryParameter]:t},headers:{"X-CSRF-TOKEN":e('meta[name="csrf-token"]').attr("content")},cache:n.settings.providerCache,dataType:"json",success:function(t){if(t.length){e.each(t,(function(t,o){let s={value:"",text:""};let r=o[n.settings.valueField];if(e('option[value="'+n.escapeQuery(r)+'"]',n.$select).length==0){s.value=r;if(o[n.settings.labelField]!==undefined){s.text=o[n.settings.labelField]}else{s.text=o[n.settings.valueField]}i.push(s)}}))}n.parseResults(i)}})};n.prototype.refreshOptions=function(e){let t=[],n=this;let i=n.$input.val().trim();e=e??false;if(i!==""||e){n.search(i)}else{n.parseResults(t)}};n.prototype.parseResults=function(e){let t,n,i,o=this;t=e.length;if(t>0&&!o.isOpen){o.dropdownOpen()}else if(t<1&&o.isOpen){o.dropdownRemove();return}if(typeof o.settings.maxOptions==="number"){t=Math.min(t,o.settings.maxOptions)}i=document.createDocumentFragment();for(n=0;n<t;n++){i.appendChild(o.render("option",e[n]))}o.$dropdown.html(i);if(o.settings.setFirstOptionActive){o.setActiveOption(o.$dropdown.find("[data-selectable]:first"))}};n.prototype.render=function(t,n){let i,o,s=this;let r=s.settings;if(t=="option"||t=="item"){o=s.escapeHtml(n["value"])}i=e(r.render[t].apply(this,[n,s.escapeHtml]));if(t=="item"&&s.isDisabled){i.find(".vr, a").remove()}if(t=="option"||t=="item"){i.attr("data-value",o)}if(t=="option"){i.attr("data-selectable","")}return i[0]};n.prototype.setActiveOption=function(e){let t=this;if(t.$activeOption!==null){t.$activeOption.removeClass("active")}t.$activeOption=e;t.$activeOption.addClass("active")};n.prototype.moveOptionsSelection=function(e){let t=this,n=0;let i=t.$dropdown.find("[data-selectable]");if(t.$activeOption!==null){n=i.index(t.$activeOption)+1}n+=e;if(n<1){n=i.length}else if(n>i.length){n=1}t.setActiveOption(i.eq(n-1))};n.prototype.onOptionSelect=function(t){let n,i=this;if(t.preventDefault){t.preventDefault();t.stopPropagation()}n=e(t.currentTarget);i.setActiveOption(n);if(t.button&&t.button===2){return}i.createItem(n.attr("data-value"),n.html())};n.prototype.createItem=function(t,n){let i=this;if(i.settings.provider!=="select"){let o=e("<option />").attr("value",i.escapeHtml(t)).html(n).attr("data-remote",1);i.$select.prepend(o)}if(typeof t!=="undefined"){i.lastValue=null;i.selectItem(t);i.setTextboxValue("");i.dropdownRemove()}};n.prototype.selectItem=function(t){let n,i=this;n=e('[value="'+i.escapeQuery(t)+'"]',i.$select);if(n.length>0){n.attr("selected","selected");i.insertAtCaret(i.render("item",{value:t,text:n.html()}));i.$select.trigger("tokenize_item_select",[t]);i.setTextboxVisibility(!i.isFull());i.setInputFocus()}};n.prototype.removeItem=function(t){let n=this;let i=e('.token[data-value="'+n.escapeQuery(t)+'"]',n.$container);let o=e('option[value="'+n.escapeQuery(t)+'"]',n.$select);if(i.length>0){i.remove()}if(o.length>0){o.removeAttr("selected");if(o.attr("data-remote")){o.remove()}}n.$select.trigger("tokenize_item_remove",[t]);n.updateSelect();n.setTextboxVisibility(!n.isFull());n.setInputFocus()};n.prototype.updateSelect=function(){let t,n,i=[],o=this;if(o.settings.sortable){i=e(".token:not(.sortable-chosen)").map((function(){return e(this).attr("data-value")})).get();e.each(i,(function(i,s){n=e('option[value="'+o.escapeQuery(s)+'"]',o.$select);if(n.length){if(t===undefined){n.prependTo(o.$select)}else{t.after(n)}t=n}}));o.$select.trigger("tokenize_item_reordered",[i])}};n.prototype.onMouseDown=function(e){let t=this;if(e.button&&e.button>0){return}if(t.settings.openOnMouseDown&&!t.isOpen){t.refreshOptions(true)}};n.prototype.onFocus=function(){let e=this;if(e.settings.openOnFocus&&!e.isOpen||e.$input.val()!==""){e.refreshOptions(true)}};n.prototype.onBlur=function(){let e=this;if(e.isOpen){e.dropdownRemove()}};n.prototype.onKeyDown=function(n){let i=this;switch(n.keyCode){case t.BACKSPACE:if(i.$input.val()===""){let t=e(".token:last",i.$container);if(t.length>0){if(t.hasClass("await")){i.removeItem(t.attr("data-value"))}else{t.addClass("await")}}}break;case t.TAB:if(!i.isShiftDown&&i.settings.selectOnTab&&i.$input.val()!==""){i.validateInput(n)}break;case t.UP:if(i.isOpen){i.moveOptionsSelection(-1)}n.preventDefault();break;case t.DOWN:if(i.isOpen){i.moveOptionsSelection(1)}n.preventDefault();break;case t.ENTER:i.validateInput(n);return;default:i.resetPending()}};n.prototype.onKeyPress=function(e){let t=this;let n=String.fromCharCode(e.keyCode||e.which);if(Array.isArray(t.settings.delimiter)&&t.settings.delimiter.indexOf(n)>=0){t.validateInput(e)}else if(n===t.settings.delimiter){t.validateInput(e)}};n.prototype.resetPending=function(){let t=this;let n=e(".token.await",t.$container);if(n.length>0){n.removeClass("await")}};n.prototype.validateInput=function(e){let t=this;e.preventDefault();t.resetPending();if(t.isOpen&&t.$activeOption){e.currentTarget=t.$activeOption;t.onOptionSelect(e)}else{t.setTextboxValue("")}};n.prototype.onInput=function(){let e=this;let t=e.$input.val()||"";if(e.lastValue!==t){e.lastValue=t;e.refreshOptions()}};n.prototype.setInputFocus=function(){let e=this;setTimeout((function(){e.$input.trigger("focus")}),20)};n.prototype.insertAtCaret=function(e){this.$input.before(e)};n.prototype.escapeHtml=function(e){return(e+"").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")};n.prototype.escapeQuery=function(e){return(e+"").replace(new RegExp(/\\/,"g"),"\\\\")};n.prototype.autoGrow=function(e){let t,n,i,o;let s=this;e.on("keydown keyup paste change blur",(function(){o=s.$input.outerWidth()-s.$input.width();i=s.$input.attr("placeholder");if(i&&s.$input.val()===""){n=s.measureString(i,e)}else{n=0}t=Math.max(s.measureString(e.val(),e),n)+o;if(t<s.$container.width()){s.$input.css("min-width",t)}s.updatePosition()}))};n.prototype.measureString=function(t,n){let i=this;if(!t){return 0}if(!i.$testInput){i.$testInput=e("<span />").css({position:"absolute",width:"auto",padding:0,whiteSpace:"pre"});e("<div />").css({position:"absolute",width:0,height:0,overflow:"hidden"}).attr({"aria-hidden":true}).append(i.$testInput).appendTo("body")}i.$testInput.text(t);i.transferStyles(n,i.$testInput,["letterSpacing","fontSize","fontFamily","fontWeight","textTransform"]);return i.$testInput.width()};n.prototype.transferStyles=function(e,t,n){let i,o,s={};if(n){for(i=0,o=n.length;i<o;i++){s[n[i]]=e.css(n[i])}}else{s=e.css()}t.css(s)};n.DEFAULTS={delimiter:",",maxOptions:10,maxItems:null,openOnFocus:false,openOnMouseDown:false,labelField:"text",valueField:"value",provider:"select",providerQueryParameter:"term",providerCache:false,sortable:true,setFirstOptionActive:true,selectOnTab:true,searchConjunction:"and",searchRespectWordBoundaries:false,layoutDirection:"row",render:{}};e.fn.GUIControlTokenize=function(t){e.each(this,(function(){let i=e(this);let o=i.data("gui.tokenize");let s=typeof t=="object"&&t;if(!o)i.data("gui.tokenize",new n(this,s))}))}}(jQuery);